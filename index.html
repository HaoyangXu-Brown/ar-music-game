<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Padmu</title>
  <style>
    /* Global Styles */
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Press Start 2P', sans-serif;
    }
    /* Home Page Styles */
    #homePage {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1e3c72, #2a5298); /* Blue gradient */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    #homePage h1 {
      font-size: 4em;
      margin-bottom: 20px;
      letter-spacing: 4px;
    }
    #description {
      background: rgba(33, 150, 243, 0.1); /* Light blue tint */
      border: 2px solid #2196f3;
      border-radius: 10px;
      padding: 20px;
      width: 80%;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 30px;
      font-size: 0.8em;
      line-height: 1.4em;
    }
    #homePage button {
      background: #2196f3;
      color: #fff;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 10px;
      transition: background 0.3s, transform 0.2s;
    }
    #homePage button:hover {
      background: #64b5f6;
      transform: scale(1.05);
    }
    /* Game Page Styles */
    #gamePage {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #130c33;
    }
    /* Left UI Panel */
    #ui-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      padding: 15px;
      border: 2px solid #2196f3;
      border-radius: 10px;
    }
    #ui-panel button {
      background: #2196f3;
      border: none;
      color: #fff;
      padding: 10px 15px;
      margin: 5px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 5px;
      transition: transform 0.2s;
    }
    #ui-panel button:hover {
      transform: scale(1.05);
    }
    /* Dropdown Menu (Top Right) */
    #dropdownMenu {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 10;
    }
    #menuBtn {
      background: #2196f3;
      border: none;
      color: #fff;
      padding: 10px 15px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 5px;
    }
    #dropdownMenuContent {
      display: none;
      position: absolute;
      right: 0;
      background: #fff;
      min-width: 150px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      border-radius: 5px;
      overflow: hidden;
      z-index: 11;
    }
    #dropdownMenuContent a {
      display: block;
      padding: 10px;
      color: #333;
      text-decoration: none;
      font-size: 12px;
    }
    #dropdownMenuContent a:hover {
      background: #2196f3;
      color: #fff;
    }
    /* Canvas */
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #130c33;
      z-index: 1;
      pointer-events: none;
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <!-- Home Page -->
  <div id="homePage">
    <h1>Padmu</h1>
    <div id="description">
      <p>
        Welcome to Padmu â€“ the ultimate AR music experience! Use your hands to create beats, mix sounds, and transform your space into a live performance stage.
      </p>
      <p>
        Play multiple instruments, enjoy a dynamic background soundtrack, and receive real-time feedback on your rhythm and skill. Immerse yourself in a world where every gesture sparks a new melody.
      </p>
    </div>
    <button id="startGameBtn">Start Game</button>
  </div>
  
  <!-- Game Page -->
  <div id="gamePage">
    <div id="ui-panel">
      <button id="drumBtn">Drum</button>
      <button id="pianoBtn">Piano</button>
      <button id="guitarBtn">Guitar</button>
      <button id="synthBtn">Synth</button>
      <button id="toggleMirror">Toggle Mirror</button>
    </div>
    <div id="dropdownMenu">
      <button id="menuBtn">Menu</button>
      <div id="dropdownMenuContent">
        <a href="#" id="pauseUnpause">Pause</a>
        <a href="#" id="muteMusic">Mute Music</a>
        <a href="#" id="restartGame">Restart</a>
        <a href="#" id="goHome">Home</a>
      </div>
    </div>
    <video id="video" playsinline></video>
    <canvas id="canvas"></canvas>
  </div>
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.js"></script>
  
  <script>
    /* ---------- Global Variables & Setup ---------- */
    let currentInstrument = 'drum', instrumentZones = [], handHistory = {}, animations = [], judgements = [];
    let mirror = false, detectionTolerance = 60, paused = false, muted = false;
    Tone.Transport.bpm.value = 120;
    const beatInterval = 60 / Tone.Transport.bpm.value;
    
    /* ---------- Custom Assets (Update paths as needed) ---------- */
    const bassImg = new Image(); bassImg.src = "bass.png";       // NEED UPDATE
    const snareImg = new Image(); snareImg.src = "snare.png";    // NEED UPDATE
    const hihatImg = new Image(); hihatImg.src = "hihat.png";    // NEED UPDATE
    const tomImg = new Image(); tomImg.src = "tom.png";          // NEED UPDATE
    const keyImg = new Image(); keyImg.src = "key.png";          // NEED UPDATE
    const guitarImg = new Image(); guitarImg.src = "guitar.png"; // NEED UPDATE
    const synthImg = new Image(); synthImg.src = "synth.png";    // NEED UPDATE
    const bgPlayer = new Tone.Player({ url: "rockyou.mp3", loop: true, volume: -12 }).toDestination(); // NEED UPDATE
    
    /* ---------- Tone.js Instruments ---------- */
    const bassDrum = new Tone.MembraneSynth().toDestination();
    const snare = new Tone.NoiseSynth({ noise: { type: "white" }, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination();
    const hiHat = new Tone.MetalSynth({ frequency: 250, envelope: { attack: 0.001, decay: 0.1, release: 0.1 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination();
    const tom = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 4, oscillator: { type: "sine" } }).toDestination();
    const pianoSynth = new Tone.Synth({ oscillator: { type: 'triangle' } }).toDestination();
    const guitarSynth = new Tone.PluckSynth().toDestination();
    const synthInst = new Tone.Synth().toDestination();
    
    /* ---------- Canvas & Video ---------- */
    const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
    const videoElement = document.getElementById('video');
    function resizeCanvas(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      updateInstrumentZones();
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);
    
    /* ---------- Instrument Zones ---------- */
    function updateInstrumentZones(){
      let baseZones = [];
      const zoneRadius = 60;
      if(currentInstrument === 'drum'){
        const drumTypes = ["bass", "snare", "hihat", "tom"];
        const zoneWidth = canvas.width / drumTypes.length;
        drumTypes.forEach((type, i) => {
          baseZones.push({ x: i * zoneWidth + zoneWidth/2, y: canvas.height * 0.8, radius: zoneRadius, triggered: false, label: type.toUpperCase(), drumType: type });
        });
      } else if(currentInstrument === 'piano'){
        const notes = ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"];
        const zoneWidth = canvas.width / notes.length;
        notes.forEach((note, i) => {
          baseZones.push({ x: i * zoneWidth + zoneWidth/2, y: canvas.height * 0.8, radius: zoneRadius, triggered: false, label: note, note: note });
        });
      } else if(currentInstrument === 'guitar'){
        const notes = ["E3", "G3", "A3", "B3", "C4", "D4", "E4"];
        const zoneWidth = canvas.width / notes.length;
        notes.forEach((note, i) => {
          baseZones.push({ x: i * zoneWidth + zoneWidth/2, y: canvas.height * 0.8, radius: zoneRadius, triggered: false, label: note, note: note });
        });
      } else if(currentInstrument === 'synth'){
        const notes = ["C4", "E4", "G4", "B4", "C5"];
        const zoneWidth = canvas.width / notes.length;
        notes.forEach((note, i) => {
          baseZones.push({ x: i * zoneWidth + zoneWidth/2, y: canvas.height * 0.8, radius: zoneRadius, triggered: false, label: note, note: note });
        });
      }
      instrumentZones = mirror ? baseZones.map(zone => ({ ...zone, x: canvas.width - zone.x })) : baseZones;
    }
    
    function drawInstrumentZones(){
      if(currentInstrument === 'drum'){
        instrumentZones.forEach(zone => drawDrum(zone));
      } else if(currentInstrument === 'piano'){
        instrumentZones.forEach(zone => drawKey(zone));
      } else if(currentInstrument === 'guitar'){
        instrumentZones.forEach(zone => drawGuitar(zone));
      } else {
        instrumentZones.forEach(zone => drawSynth(zone));
      }
    }
    
    function drawDrum(zone){
      const size = zone.radius * 2, x = zone.x - zone.radius, y = zone.y - zone.radius;
      ctx.save(); ctx.imageSmoothingEnabled = false;
      if(zone.drumType === "bass") ctx.drawImage(bassImg, x, y, size, size);
      else if(zone.drumType === "snare") ctx.drawImage(snareImg, x, y, size, size);
      else if(zone.drumType === "hihat") ctx.drawImage(hihatImg, x, y, size, size);
      else if(zone.drumType === "tom") ctx.drawImage(tomImg, x, y, size, size);
      ctx.font = "bold 14px 'Press Start 2P', sans-serif"; ctx.fillStyle = "#000"; ctx.textAlign = "center";
      ctx.fillText(zone.label, zone.x, zone.y + 20); ctx.restore();
    }
    
    function drawKey(zone){
      const keyW = zone.radius * 2, keyH = zone.radius * 2, x = zone.x - zone.radius, y = zone.y - zone.radius;
      ctx.save(); ctx.imageSmoothingEnabled = false;
      ctx.drawImage(keyImg, x, y, keyW, keyH);
      ctx.font = "bold 14px 'Press Start 2P', sans-serif"; ctx.fillStyle = "#333"; ctx.textAlign = "center";
      ctx.fillText(zone.label, zone.x, zone.y + 20); ctx.restore();
    }
    
    function drawGuitar(zone){
      const w = zone.radius * 2, h = zone.radius * 2, x = zone.x - zone.radius, y = zone.y - zone.radius;
      ctx.save(); ctx.imageSmoothingEnabled = false;
      ctx.drawImage(guitarImg, x, y, w, h);
      ctx.font = "bold 14px 'Press Start 2P', sans-serif"; ctx.fillStyle = "#333"; ctx.textAlign = "center";
      ctx.fillText(zone.label, zone.x, zone.y + 20); ctx.restore();
    }
    
    function drawSynth(zone){
      const w = zone.radius * 2, h = zone.radius * 2, x = zone.x - zone.radius, y = zone.y - zone.radius;
      ctx.save(); ctx.imageSmoothingEnabled = false;
      ctx.drawImage(synthImg, x, y, w, h);
      ctx.font = "bold 14px 'Press Start 2P', sans-serif"; ctx.fillStyle = "#333"; ctx.textAlign = "center";
      ctx.fillText(zone.label, zone.x, zone.y + 20); ctx.restore();
    }
    
    function addHitAnimation(x, y){ animations.push({ x, y, startTime: Date.now(), duration: 300 }); }
    function addJudgement(zone) {
      const t = Tone.Transport.seconds, remainder = t % beatInterval, diff = Math.min(remainder, beatInterval - remainder);
      const judgementText = diff < 0.1 ? "Perfect" : diff < 0.2 ? "Fine" : "Poor";
      judgements.push({ text: judgementText, x: zone.x, y: zone.y - zone.radius - 20, startTime: Date.now(), duration: 1000 });
    }
    
    function drawAnimations(){
      const now = Date.now();
      animations = animations.filter(anim => {
        const elapsed = now - anim.startTime;
        if(elapsed < anim.duration){
          const progress = elapsed / anim.duration, size = 20 + progress * 30;
          ctx.fillStyle = "rgba(255,215,0," + (1 - progress) + ")";
          ctx.beginPath(); ctx.arc(anim.x, anim.y, size/2, 0, 2 * Math.PI); ctx.fill();
          return true;
        }
        return false;
      });
    }
    
    function drawJudgements(){
      const now = Date.now();
      judgements = judgements.filter(judg => {
        const elapsed = now - judg.startTime;
        if(elapsed < judg.duration){
          const alpha = 1 - (elapsed / judg.duration);
          ctx.font = "bold 20px 'Press Start 2P', sans-serif";
          ctx.fillStyle = "rgba(255,255,255," + alpha + ")";
          ctx.textAlign = "center";
          ctx.fillText(judg.text, judg.x, judg.y);
          return true;
        }
        return false;
      });
    }
    
    function drawHandTrails(){
      const now = Date.now();
      for(let key in handHistory) {
        handHistory[key].forEach(sample => {
          const age = now - sample.time, alpha = Math.max(0, 1 - age/500);
          ctx.beginPath();
          ctx.arc(sample.x, sample.y, 4, 0, 2 * Math.PI);
          ctx.fillStyle = "rgba(0,255,255," + alpha + ")";
          ctx.fill();
        });
      }
    }
    
    function detectPatGestureFinger(handIndex, fingerIndex, x, y){
      const key = handIndex + "_" + fingerIndex;
      if(!handHistory[key]) handHistory[key] = [];
      handHistory[key].push({ x, y, time: Date.now() });
      if(handHistory[key].length > 10) handHistory[key].shift();
      if(handHistory[key].length >= 2){
        const first = handHistory[key][0],
              last = handHistory[key][handHistory[key].length - 1],
              dy = last.y - first.y,
              dt = (last.time - first.time) / 1000;
        if(dy/dt > 1000) return true;
      }
      return false;
    }
    
    function triggerSound(zone){
      if(currentInstrument === 'drum'){
        if(zone.drumType === "bass") bassDrum.triggerAttackRelease("C1", "8n");
        else if(zone.drumType === "snare") snare.triggerAttackRelease("16n");
        else if(zone.drumType === "hihat") hiHat.triggerAttackRelease("16n");
        else if(zone.drumType === "tom") tom.triggerAttackRelease("C2", "8n");
      } else if(currentInstrument === 'piano'){
        pianoSynth.triggerAttackRelease(zone.note, "8n");
      } else if(currentInstrument === 'guitar'){
        guitarSynth.triggerAttackRelease(zone.note, "8n");
      } else if(currentInstrument === 'synth'){
        synthInst.triggerAttackRelease(zone.note, "8n");
      }
      addHitAnimation(zone.x, zone.y);
      addJudgement(zone);
    }
    
    const hands = new window.Hands({ locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);
    
    const camera = new window.Camera(videoElement, { 
      onFrame: async () => { await hands.send({ image: videoElement }); },
      width: window.innerWidth, height: window.innerHeight 
    });
    camera.start();
    
    function onResults(results){
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if(mirror){
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
        ctx.restore();
      } else {
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
      }
      
      if(paused){
        ctx.font = "bold 40px 'Press Start 2P', sans-serif";
        ctx.fillStyle = "rgba(255,255,255,0.8)";
        ctx.textAlign = "center";
        ctx.fillText("Paused", canvas.width/2, canvas.height/2);
        ctx.restore();
        return;
      }
      
      drawInstrumentZones();
      if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0){
        results.multiHandLandmarks.forEach((landmarks, handIndex) => {
          if(mirror){
            ctx.save();
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            window.drawConnectors(ctx, landmarks, window.HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
            window.drawLandmarks(ctx, landmarks, { color: '#FF0000', lineWidth: 1 });
            ctx.restore();
          } else {
            window.drawConnectors(ctx, landmarks, window.HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
            window.drawLandmarks(ctx, landmarks, { color: '#FF0000', lineWidth: 1 });
          }
          const fingerIndices = [4, 8, 12, 16, 20];
          fingerIndices.forEach(fingerIndex => {
            let fingerTip = landmarks[fingerIndex];
            let rawX = fingerTip.x * canvas.width, rawY = fingerTip.y * canvas.height;
            let x = mirror ? canvas.width - rawX : rawX, y = rawY;
            ctx.fillStyle = "yellow";
            ctx.fillRect(x - 2, y - 2, 4, 4);
            if(detectPatGestureFinger(handIndex, fingerIndex, x, y)){
              instrumentZones.forEach(zone => {
                let dx = x - zone.x, dy = y - zone.y, distance = Math.sqrt(dx*dx + dy*dy);
                if(distance < zone.radius + detectionTolerance && !zone.triggered){
                  zone.triggered = true;
                  triggerSound(zone);
                  setTimeout(() => { zone.triggered = false; }, 300);
                }
              });
            }
          });
        });
      }
      drawHandTrails();
      drawAnimations();
      drawJudgements();
      ctx.restore();
    }
    
    /* ------------------ UI & Dropdown Menu ------------------ */
    document.getElementById('drumBtn').addEventListener('click', function(){ currentInstrument = 'drum'; updateInstrumentZones(); });
    document.getElementById('pianoBtn').addEventListener('click', function(){ currentInstrument = 'piano'; updateInstrumentZones(); });
    document.getElementById('guitarBtn').addEventListener('click', function(){ currentInstrument = 'guitar'; updateInstrumentZones(); });
    document.getElementById('synthBtn').addEventListener('click', function(){ currentInstrument = 'synth'; updateInstrumentZones(); });
    document.getElementById('toggleMirror').addEventListener('click', function(){ mirror = !mirror; updateInstrumentZones(); });
    
    document.getElementById('menuBtn').addEventListener('click', function(e){
      e.stopPropagation();
      const menuContent = document.getElementById('dropdownMenuContent');
      menuContent.style.display = (menuContent.style.display === 'block') ? 'none' : 'block';
    });
    
    document.getElementById('pauseUnpause').addEventListener('click', function(e){
      e.preventDefault();
      paused = !paused;
      this.textContent = paused ? "Unpause" : "Pause";
      document.getElementById('dropdownMenuContent').style.display = 'none';
      if(paused){
        Tone.Transport.pause();
        bgPlayer.pause();
      } else {
        Tone.Transport.start();
        bgPlayer.start();
      }
    });
    
    document.getElementById('muteMusic').addEventListener('click', function(e){
      e.preventDefault();
      muted = !muted;
      this.textContent = muted ? "Unmute Music" : "Mute Music";
      document.getElementById('dropdownMenuContent').style.display = 'none';
      bgPlayer.mute = muted;
    });
    
    document.getElementById('restartGame').addEventListener('click', function(e){
      e.preventDefault();
      location.reload();
    });
    
    document.getElementById('goHome').addEventListener('click', function(e){
      e.preventDefault();
      document.getElementById('gamePage').style.display = 'none';
      document.getElementById('homePage').style.display = 'flex';
      Tone.Transport.stop();
      bgPlayer.stop();
    });
    
    document.getElementById('startGameBtn').addEventListener('click', async function(){
      await Tone.start();
      bgPlayer.start();
      document.getElementById('homePage').style.display = 'none';
      document.getElementById('gamePage').style.display = 'block';
      Tone.Transport.start();
    });
  </script>
</body>
</html>
